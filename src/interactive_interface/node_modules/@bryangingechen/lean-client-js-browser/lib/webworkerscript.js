"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const inprocess_1 = require("./inprocess");
let conn = null;
onmessage = (e) => {
    const req = e.data;
    switch (req.command) {
        case 'start-webworker':
            const opts = req.opts;
            const loadJs = (url) => new Promise((resolve) => { importScripts(url); resolve(); });
            const loadOleanMap = (url) => fetch(url).then((res) => res.ok && res.json());
            const oleanMapUrl = opts.libraryOleanMap || (opts.libraryZip.slice(0, -3) + 'olean_map.json');
            conn = new inprocess_1.InProcessTransport(() => inprocess_1.loadJsOrWasm(opts, loadJs), inprocess_1.loadBufferFromURLCached(opts.libraryZip, opts.libraryMeta, opts.libraryKey, opts.dbName), opts.memoryMB || 256, () => loadOleanMap(oleanMapUrl)).connect();
            conn.jsonMessage.on((msg) => postMessage(msg));
            conn.error.on((error) => postMessage({ response: 'webworker-error', error }));
            break;
        default:
            if (conn) {
                conn.send(req);
            }
    }
};
exports.default = {};
